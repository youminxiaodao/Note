KOCA重构后，需掌握订单系统



期权日间交易

## 系统架构

### 订单子系统

金证微架构

期权是现货的衍生品

订单子系统与集中交易系统交互（KCXP） 证券锁定、解锁

未来：C++微架构或转为linux下，数据库可能转为Oracle

### 风控子系统

采集各个系统的数据，实时性

BP架构--》微架构--〉java大数据架构



### 管理子系统

功能：清算、维护

未来：转为java开发，拆分成多个微服务

### 前端

现：KJDP

未来：VUE



### 清算后数据上场

现（在清算后）：web--》管理子系统--〉订单子系统

未：日间发布订阅

### 客户开户流程

现：账户---》管理---〉订单

未：调整整个流程



### 登陆流程

现：网上交易客户端---》管理子系统



### 密码修改

实时性

客户端--〉账户子系统--》管理子系统---〉订单子系统



### 数据下场处理

作用：

晚上数据和日间数据进行核对

归档





## 关键表

### 账户表

#### 客户表

CUSTOMER

#### 证券交易账户

STK_TRDACCT

清算以交易单元一致，日间以报盘席位一致

报盘席位正常情况下与交易单元一致

特殊情况下多个交易单于与报盘席位配对（）



### 资金表

CUACCT_FUND

余额（清算后）=可用+保证金

日间买卖，余额不变

paylater：券商帮忙垫付

### 持仓表

合约资产

OPT_ASSET

买：不做冻结

买多少，解冻就多少

权利金不包含费用

买入额度只有权利仓才有

组合业务目的：节省保证金

组合持仓明细

OPT_COMB_ASSET_DETAIL

中登级保证金（交易所）、公司级保证金（券商）

### 委托表

OPT_ORDER

### 成交表

OPT_MATCHING



## 交易流程

### 委托流程

#### 交易前端控制

账户规则校验

品种规则校验

行为规则校验

风控规则控制

#### 资金试算

计算权利金

计算保证金

计算费用

精确到分，落库放大1000，四舍五入规则需一致

#### 资金冻结

权利金冻结

费用冻结

保证金冻结

委托的时候足额冻结，成交的时候释放冻结

#### 持仓冻结

权利仓冻结

义务仓冻结

备对仓冻结

组合持仓冻结

#### 生成委托

生成合同序号

插入委托序号

#### 交易报盘

上交所报盘

深交所报盘

内嵌报盘

### 成交流程

#### 有效性检查

#### 资金清算

#### 持仓清算（释放原持仓冻结）

#### 更新委托表

#### 生成成交

#### 成交推送



### 撤单流程

#### 重复撤单检查

#### 委托生成

#### 报盘申报

#### 内部成交（转成交流程）



### 日间盯市流程

日间保证金盯市

日间持仓盯市







资金可取原则：当日权利金净收入不可提取，当日平仓释放现金保证金可提取等。

提取线：

行挂单、非对冲、静态/动态占用保证金



保证金风险度